define(["exports","./when-54c2dc71","./Check-6c0211bc","./Math-fc8cecf5","./Cartesian2-bddc1162","./Transforms-6f81ad4c"],(function(a,t,e,r,n,i){"use strict";var s={};function o(a,t,e){var n=a+t;return r.CesiumMath.sign(a)!==r.CesiumMath.sign(t)&&Math.abs(n/Math.max(Math.abs(a),Math.abs(t)))<e?0:n}s.computeDiscriminant=function(a,t,e){return t*t-4*a*e},s.computeRealRoots=function(a,t,e){if(0===a)return 0===t?[]:[-e/t];if(0===t){if(0===e)return[0,0];var n=Math.abs(e),i=Math.abs(a);return n<i&&n/i<r.CesiumMath.EPSILON14?[0,0]:i<n&&i/n<r.CesiumMath.EPSILON14||(i=-e/a)<0?[]:[-(n=Math.sqrt(i)),n]}return 0===e?(i=-t/a)<0?[i,0]:[0,i]:(i=o(t*t,-4*a*e,r.CesiumMath.EPSILON14))<0?[]:(i=-.5*o(t,r.CesiumMath.sign(t)*Math.sqrt(i),r.CesiumMath.EPSILON14),0<t?[i/a,e/i]:[e/i,i/a])};var u={};function c(a,t,e,r){var n=t/3,i=e/3,s=(d=a)*i,o=n*(C=r);if((e=4*(m=d*i-(M=n*n))*(t=n*C-(h=i*i))-(a=d*C-n*i)*a)<0){r=s*h<=M*o?-2*n*(l=m)+(u=d)*a:-(u=C)*a+2*i*(l=t);var u=(u=(f=(c=-(r<0?-1:1)*Math.abs(u)*Math.sqrt(-e))-r)/2)<0?-Math.pow(-u,1/3):Math.pow(u,1/3),c=f===c?-u:-l/u;return c=l<=0?u+c:-r/(u*u+c*c+l),s*h<=M*o?[(c-n)/d]:[-C/(c+i)]}var C,l=m,h=(s=-2*n*m+d*a,t),M=-C*a+2*i*t,m=(o=Math.sqrt(e),Math.sqrt(3)/2),d=(a=Math.abs(Math.atan2(d*o,-s)/3),(s=2*n<(f=(c=2*Math.sqrt(-l))*(t=Math.cos(a)))+(e=c*(-t/2-m*Math.sin(a)))?f-n:e-n)/(l=d)),f=(a=Math.abs(Math.atan2(C*o,-M)/3),(C=-C)/(a=(f=(c=2*Math.sqrt(-h))*(t=Math.cos(a)))+(e=c*(-t/2-m*Math.sin(a)))<2*i?f+i:e+i));return d<=(a=(i*(e=-s*a-l*C)-n*(s*C))/(-n*e+i*(l*a)))?d<=f?a<=f?[d,a,f]:[d,f,a]:[f,d,a]:d<=f?[a,d,f]:a<=f?[a,f,d]:[f,a,d]}u.computeDiscriminant=function(a,t,e,r){var n=t*t,i=e*e;return 18*a*t*e*r+n*i-a*a*27*(r*r)-4*(a*i*e+n*t*r)},u.computeRealRoots=function(a,t,e,r){var n;if(0===a)return s.computeRealRoots(t,e,r);if(0!==t)return 0===e?0===r?(i=-t/a)<0?[i,0,0]:[0,0,i]:c(a,t,0,r):0===r?0===(n=s.computeRealRoots(a,t,e)).length?[0]:n[1]<=0?[n[0],n[1],0]:0<=n[0]?[0,n[0],n[1]]:[n[0],0,n[1]]:c(a,t,e,r);if(0!==e)return 0===r?0===(n=s.computeRealRoots(a,0,e)).Length?[0]:[n[0],0,n[1]]:c(a,0,e,r);if(0===r)return[0,0,0];var i=(i=-r/a)<0?-Math.pow(-i,1/3):Math.pow(i,1/3);return[i,i,i]};var C={};function l(a,t,e,n){var i=a*a,o=t-3*i/8,c=e-t*a/2+i*a/8;if(n=n-e*a/4+t*i/16-3*i*i/256,0<(e=u.computeRealRoots(1,2*o,o*o-4*n,-c*c)).length){if(t=-a/4,i=e[e.length-1],Math.abs(i)<r.CesiumMath.EPSILON14){if(2===(a=s.computeRealRoots(1,o,n)).length){e=a[0];var C=a[1];if(0<=e&&0<=C)return n=Math.sqrt(e),[t-(a=Math.sqrt(C)),t-n,t+n,t+a];if(0<=e&&C<0)return[t-(l=Math.sqrt(e)),t+l];if(e<0&&0<=C)return[t-(l=Math.sqrt(C)),t+l]}return[]}if(0<i){var l=(o+i-c/(C=Math.sqrt(i)))/2;return c=(o+i+c/C)/2,l=s.computeRealRoots(1,C,l),c=s.computeRealRoots(1,-C,c),0!==l.length?(l[0]+=t,l[1]+=t,0!==c.length?(c[0]+=t,c[1]+=t,l[1]<=c[0]?[l[0],l[1],c[0],c[1]]:c[1]<=l[0]?[c[0],c[1],l[0],l[1]]:l[0]>=c[0]&&l[1]<=c[1]?[c[0],l[0],l[1],c[1]]:c[0]>=l[0]&&c[1]<=l[1]?[l[0],c[0],c[1],l[1]]:l[0]>c[0]&&l[0]<c[1]?[c[0],l[0],c[1],l[1]]:[l[0],c[0],l[1],c[1]]):l):0!==c.length?(c[0]+=t,c[1]+=t,c):[]}}return[]}function h(a,t,e,n){var i=-2*t,o=e*a+t*t-4*n,c=(f=a*a)*n-e*t*a+e*e;if(0<(d=u.computeRealRoots(1,i,o,c)).length){var C,l,h,M,m=d[0],d=(c=a/2,(i=t-m)/2),f=(t=(o=i*i)-4*n,i=o+4*Math.abs(n),o=f-4*m,f+4*Math.abs(m));l=m<0||t*f<o*i?(C=(o=Math.sqrt(o))/2,0===o?0:(a*d-e)/o):(C=0===(l=Math.sqrt(t))?0:(a*d-e)/l,l/2),0==c&&0===C?M=h=0:r.CesiumMath.sign(c)===r.CesiumMath.sign(C)?M=m/(h=c+C):h=m/(M=c-C),0==d&&0===l?p=g=0:r.CesiumMath.sign(d)===r.CesiumMath.sign(l)?p=n/(g=d+l):g=n/(p=d-l);var g=s.computeRealRoots(1,h,g),p=s.computeRealRoots(1,M,p);if(0!==g.length)return 0!==p.length?g[1]<=p[0]?[g[0],g[1],p[0],p[1]]:p[1]<=g[0]?[p[0],p[1],g[0],g[1]]:g[0]>=p[0]&&g[1]<=p[1]?[p[0],g[0],g[1],p[1]]:p[0]>=g[0]&&p[1]<=g[1]?[g[0],p[0],p[1],g[1]]:g[0]>p[0]&&g[0]<p[1]?[p[0],g[0],p[1],g[1]]:[g[0],p[0],g[1],p[1]]:g;if(0!==p.length)return p}return[]}function M(a,e){e=n.Cartesian3.clone(t.defaultValue(e,n.Cartesian3.ZERO)),n.Cartesian3.equals(e,n.Cartesian3.ZERO)||n.Cartesian3.normalize(e,e),this.origin=n.Cartesian3.clone(t.defaultValue(a,n.Cartesian3.ZERO)),this.direction=e}C.computeDiscriminant=function(a,t,e,r,n){var i=a*a,s=t*t,o=s*t,u=e*e,c=u*e,C=r*r,l=C*r,h=n*n;return s*u*C-4*o*l-4*a*c*C+18*a*t*e*l-27*i*C*C+i*a*256*(h*n)+n*(18*o*e*r-4*s*c+16*a*u*u-80*a*t*u*r-6*a*s*C+144*i*e*C)+h*(144*a*s*e-27*s*s-128*i*u-192*i*t*r)},C.computeRealRoots=function(a,t,e,n,i){if(Math.abs(a)<r.CesiumMath.EPSILON15)return u.computeRealRoots(t,e,n,i);var s=t/a,o=e/a,c=n/a,C=i/a;switch(a=s<0?1:0,a+=o<0?a+1:a,a+=c<0?a+1:a,a+=C<0?a+1:a){case 0:return l(s,o,c,C);case 1:case 2:return h(s,o,c,C);case 3:case 4:return l(s,o,c,C);case 5:return h(s,o,c,C);case 6:case 7:return l(s,o,c,C);case 8:return h(s,o,c,C);case 9:case 10:return l(s,o,c,C);case 11:return h(s,o,c,C);case 12:case 13:case 14:case 15:return l(s,o,c,C);default:return}},M.clone=function(a,e){if(t.defined(a))return t.defined(e)?(e.origin=n.Cartesian3.clone(a.origin),e.direction=n.Cartesian3.clone(a.direction),e):new M(a.origin,a.direction)},M.getPoint=function(a,e,r){return t.defined(r)||(r=new n.Cartesian3),r=n.Cartesian3.multiplyByScalar(a.direction,e,r),n.Cartesian3.add(a.origin,r,r)};var m={rayPlane:function(a,e,i){t.defined(i)||(i=new n.Cartesian3);var s=a.origin,o=a.direction,u=e.normal;if(a=n.Cartesian3.dot(u,o),!(Math.abs(a)<r.CesiumMath.EPSILON15||(a=(-e.distance-n.Cartesian3.dot(u,s))/a)<0))return i=n.Cartesian3.multiplyByScalar(o,a,i),n.Cartesian3.add(s,i,i)}},d=new n.Cartesian3,f=new n.Cartesian3,g=new n.Cartesian3,p=new n.Cartesian3,v=new n.Cartesian3;m.rayTriangleParametric=function(a,e,i,s,o){o=t.defaultValue(o,!1);var u,c,C,l=a.origin,h=a.direction,M=n.Cartesian3.subtract(i,e,d);if(a=n.Cartesian3.subtract(s,e,f),i=n.Cartesian3.cross(h,a,g),s=n.Cartesian3.dot(M,i),o){if(s<r.CesiumMath.EPSILON6)return;if(w=n.Cartesian3.subtract(l,e,p),(m=n.Cartesian3.dot(w,i))<0||s<m)return;if(u=n.Cartesian3.cross(w,M,v),(c=n.Cartesian3.dot(h,u))<0||s<m+c)return;C=n.Cartesian3.dot(a,u)/s}else{if(Math.abs(s)<r.CesiumMath.EPSILON6)return;s=1/s;var m,w=n.Cartesian3.subtract(l,e,p);if((m=n.Cartesian3.dot(w,i)*s)<0||1<m)return;if(u=n.Cartesian3.cross(w,M,v),(c=n.Cartesian3.dot(h,u)*s)<0||1<m+c)return;C=n.Cartesian3.dot(a,u)*s}return C},m.rayTriangle=function(a,e,r,i,s,o){if(s=m.rayTriangleParametric(a,e,r,i,s),t.defined(s)&&!(s<0))return t.defined(o)||(o=new n.Cartesian3),n.Cartesian3.multiplyByScalar(a.direction,s,o),n.Cartesian3.add(a.origin,o,o)};var w=new M;m.lineSegmentTriangle=function(a,e,r,i,s,o,u){var c=w;if(n.Cartesian3.clone(a,c.origin),n.Cartesian3.subtract(e,a,c.direction),n.Cartesian3.normalize(c.direction,c.direction),o=m.rayTriangleParametric(c,r,i,s,o),!(!t.defined(o)||o<0||o>n.Cartesian3.distance(a,e)))return t.defined(u)||(u=new n.Cartesian3),n.Cartesian3.multiplyByScalar(c.direction,o,u),n.Cartesian3.add(c.origin,u,u)};var R={root0:0,root1:0};function S(a,e,r){t.defined(r)||(r=new i.Interval);var s=a.origin,o=a.direction;if(a=e.center,e=e.radius*e.radius,a=n.Cartesian3.subtract(s,a,g),e=function(a,t,e,r){if(!((i=t*t-4*a*e)<0)){if(0<i){var n=1/(2*a),i=(-t+(e=Math.sqrt(i)))*n;return i<(n*=-t-e)?(r.root0=i,r.root1=n):(r.root0=n,r.root1=i),r}if(0!=(a=-t/(2*a)))return r.root0=r.root1=a,r}}(n.Cartesian3.dot(o,o),2*n.Cartesian3.dot(o,a),n.Cartesian3.magnitudeSquared(a)-e,R),t.defined(e))return r.start=e.root0,r.stop=e.root1,r}m.raySphere=function(a,e,r){if(r=S(a,e,r),t.defined(r)&&!(r.stop<0))return r.start=Math.max(r.start,0),r};var O=new M;m.lineSegmentSphere=function(a,e,r,i){var s=O;if(n.Cartesian3.clone(a,s.origin),e=n.Cartesian3.subtract(e,a,s.direction),a=n.Cartesian3.magnitude(e),n.Cartesian3.normalize(e,e),i=S(s,r,i),!(!t.defined(i)||i.stop<0||i.start>a))return i.start=Math.max(i.start,0),i.stop=Math.min(i.stop,a),i};var x=new n.Cartesian3,y=new n.Cartesian3;function P(a,t,e){var n=a+t;return r.CesiumMath.sign(a)!==r.CesiumMath.sign(t)&&Math.abs(n/Math.max(Math.abs(a),Math.abs(t)))<e?0:n}m.rayEllipsoid=function(a,t){var e,r,s=t.oneOverRadii,o=n.Cartesian3.multiplyComponents(s,a.origin,x);if(t=n.Cartesian3.multiplyComponents(s,a.direction,y),s=n.Cartesian3.magnitudeSquared(o),a=n.Cartesian3.dot(o,t),1<s){if(0<=a)return;var u,c,C=s-1;if((o=a*a)<(c=(u=n.Cartesian3.magnitudeSquared(t))*C))return;if(c<o){e=a*a-c;var l=(r=-a+Math.sqrt(e))/u;return l<(o=C/r)?new i.Interval(l,o):{start:o,stop:l}}return l=Math.sqrt(C/u),new i.Interval(l,l)}return s<1?(C=s-1,e=a*a-(c=(u=n.Cartesian3.magnitudeSquared(t))*C),r=-a+Math.sqrt(e),new i.Interval(0,r/u)):a<0?(u=n.Cartesian3.magnitudeSquared(t),new i.Interval(0,-a/u)):void 0};var b=new n.Cartesian3,N=new n.Cartesian3,q=new n.Cartesian3,L=new n.Cartesian3,I=new n.Cartesian3,E=new i.Matrix3,z=new i.Matrix3,T=new i.Matrix3,U=new i.Matrix3,W=new i.Matrix3,B=new i.Matrix3,V=new i.Matrix3,Z=new n.Cartesian3,A=new n.Cartesian3,D=new n.Cartographic;m.grazingAltitudeLocation=function(a,e){var o=a.origin,u=a.direction;if(!n.Cartesian3.equals(o,n.Cartesian3.ZERO)){var c=e.geodeticSurfaceNormal(o,b);if(0<=n.Cartesian3.dot(u,c))return o}var l=t.defined(this.rayEllipsoid(a,e)),h=e.transformPositionToScaledSpace(u,b),M=(c=n.Cartesian3.normalize(h,h),a=n.Cartesian3.mostOrthogonalAxis(h,L),h=n.Cartesian3.normalize(n.Cartesian3.cross(a,c,N),N),a=n.Cartesian3.normalize(n.Cartesian3.cross(c,h,q),q),E);M[0]=c.x,M[1]=c.y,M[2]=c.z,M[3]=h.x,M[4]=h.y,M[5]=h.z,M[6]=a.x,M[7]=a.y,M[8]=a.z,c=i.Matrix3.transpose(M,z);var m=i.Matrix3.fromScale(e.radii,T);h=i.Matrix3.fromScale(e.oneOverRadii,U),(a=W)[0]=0,a[1]=-u.z,a[2]=u.y,a[3]=u.z,a[4]=0,a[5]=-u.x,a[6]=-u.y,a[7]=u.x,a[8]=0,h=i.Matrix3.multiply(i.Matrix3.multiply(c,h,B),a,B),a=i.Matrix3.multiply(i.Matrix3.multiply(h,m,V),M,V),h=i.Matrix3.multiplyByVector(h,o,I);var d,f=function(a,t,e,o,u){var c,l=1*(a[i.Matrix3.COLUMN1ROW1]-a[i.Matrix3.COLUMN2ROW2]),h=1*(0*P(a[i.Matrix3.COLUMN1ROW0],a[i.Matrix3.COLUMN0ROW1],r.CesiumMath.EPSILON15)+t.y),M=0*a[i.Matrix3.COLUMN0ROW0]+1*a[i.Matrix3.COLUMN2ROW2]+0*t.x+0,m=1*P(a[i.Matrix3.COLUMN2ROW1],a[i.Matrix3.COLUMN1ROW2],r.CesiumMath.EPSILON15),d=1*(0*P(a[i.Matrix3.COLUMN2ROW0],a[i.Matrix3.COLUMN0ROW2])+t.z),f=[];if(0==d&&0==m){if(0===(c=s.computeRealRoots(l,h,M)).length)return f;var g=c[0],p=Math.sqrt(Math.max(1-g*g,0));return f.push(new n.Cartesian3(0,1*g,1*-p)),f.push(new n.Cartesian3(0,1*g,1*p)),2===c.length&&(v=c[1],w=Math.sqrt(Math.max(1-v*v,0)),f.push(new n.Cartesian3(0,1*v,1*-w)),f.push(new n.Cartesian3(0,1*v,1*w))),f}var v=l*l+(g=m*m),w=2*(h*l+(p=d*m));if(g=2*M*l+h*h-g+(t=d*d),p=2*(M*h-p),t=M*M-t,0==v&&0==w&&0==g&&0==p)return f;var R=(c=C.computeRealRoots(v,w,g,p,t)).length;if(0===R)return f;for(var S=0;S<R;++S){var O=c[S],x=O*O,y=Math.max(1-x,0);y=Math.sqrt(y),(x=(x=r.CesiumMath.sign(l)===r.CesiumMath.sign(M)?P(l*x+M,h*O,r.CesiumMath.EPSILON12):r.CesiumMath.sign(M)===r.CesiumMath.sign(h*O)?P(l*x,h*O+M,r.CesiumMath.EPSILON12):P(l*x+h*O,M,r.CesiumMath.EPSILON12))*P(m*O,d,r.CesiumMath.EPSILON15))<0?f.push(new n.Cartesian3(0,1*O,1*y)):0<x?f.push(new n.Cartesian3(0,1*O,1*-y)):0!==y?(f.push(new n.Cartesian3(0,1*O,1*-y)),f.push(new n.Cartesian3(0,1*O,1*y)),++S):f.push(new n.Cartesian3(0,1*O,1*y))}return f}(a,n.Cartesian3.negate(h,b)),g=f.length;if(0<g){for(var p=n.Cartesian3.clone(n.Cartesian3.ZERO,A),v=Number.NEGATIVE_INFINITY,w=0;w<g;++w){d=i.Matrix3.multiplyByVector(m,i.Matrix3.multiplyByVector(M,f[w],Z),Z);var R=n.Cartesian3.normalize(n.Cartesian3.subtract(d,o,L),L);v<(R=n.Cartesian3.dot(R,u))&&(v=R,p=n.Cartesian3.clone(d,p))}return a=e.cartesianToCartographic(p,D),v=r.CesiumMath.clamp(v,0,1),h=n.Cartesian3.magnitude(n.Cartesian3.subtract(p,o,L))*Math.sqrt(1-v*v),h=l?-h:h,a.height=h,e.cartographicToCartesian(a,new n.Cartesian3)}};var k=new n.Cartesian3;m.lineSegmentPlane=function(a,e,i,s){t.defined(s)||(s=new n.Cartesian3);var o=n.Cartesian3.subtract(e,a,k),u=i.normal;if(e=n.Cartesian3.dot(u,o),!(Math.abs(e)<r.CesiumMath.EPSILON6||(u=n.Cartesian3.dot(u,a),(e=-(i.distance+u)/e)<0||1<e)))return n.Cartesian3.multiplyByScalar(o,e,s),n.Cartesian3.add(a,s,s),s},m.trianglePlaneIntersection=function(a,t,e,r){var i,s,o=r.normal,u=r.distance,c=n.Cartesian3.dot(o,a)+u<0,C=n.Cartesian3.dot(o,t)+u<0;if(o=n.Cartesian3.dot(o,e)+u<0,u=0,u+=c?1:0,u+=C?1:0,1!=(u+=o?1:0)&&2!=u||(i=new n.Cartesian3,s=new n.Cartesian3),1==u){if(c)return m.lineSegmentPlane(a,t,r,i),m.lineSegmentPlane(a,e,r,s),{positions:[a,t,e,i,s],indices:[0,3,4,1,2,4,1,4,3]};if(C)return m.lineSegmentPlane(t,e,r,i),m.lineSegmentPlane(t,a,r,s),{positions:[a,t,e,i,s],indices:[1,3,4,2,0,4,2,4,3]};if(o)return m.lineSegmentPlane(e,a,r,i),m.lineSegmentPlane(e,t,r,s),{positions:[a,t,e,i,s],indices:[2,3,4,0,1,4,0,4,3]}}else if(2==u){if(!c)return m.lineSegmentPlane(t,a,r,i),m.lineSegmentPlane(e,a,r,s),{positions:[a,t,e,i,s],indices:[1,2,4,1,4,3,0,3,4]};if(!C)return m.lineSegmentPlane(e,t,r,i),m.lineSegmentPlane(a,t,r,s),{positions:[a,t,e,i,s],indices:[2,0,4,2,4,3,1,3,4]};if(!o)return m.lineSegmentPlane(a,e,r,i),m.lineSegmentPlane(t,e,r,s),{positions:[a,t,e,i,s],indices:[0,1,4,0,4,3,2,3,4]}}},a.IntersectionTests=m,a.Ray=M}));